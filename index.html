<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magic Jar</title>
  <style>
    /* Background Canvas Styling */
    #bgCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1; /* Keeps it behind the jar */
      display: block;
      background: #02030a;
    }

    body {
      margin: 0;
      height: 100vh;
      /* Adjusted gradient to be slightly transparent to see the stars */
      background: radial-gradient(circle at top, rgba(62, 36, 101, 0.8), rgba(2, 6, 23, 0.9));
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, sans-serif;
      color: white;
      overflow: hidden;
    }

    .scene { position: relative; text-align: center; z-index: 10; }

    .jar-wrapper {
      position: relative;
      width: 220px;
      height: 340px;
      margin-bottom: 24px;
    }

    .jar {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 280px;
      border-radius: 60px;
      background: linear-gradient(to bottom, rgba(165,243,252,0.35), rgba(99,102,241,0.3), rgba(236,72,153,0.35));
      border: 4px solid #bae6fd;
      backdrop-filter: blur(6px);
      box-shadow: 0 0 40px rgba(120,200,255,0.6);
      overflow: hidden;
      z-index: 1;
    }

    .neck {
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 110px;
      height: 36px;
      border-radius: 20px;
      border: 4px solid #bae6fd;
      background: rgba(165,243,252,0.4);
      z-index: 3;
    }

    .lid {
      position: absolute;
      top: -46px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(to right, #fde68a, #f59e0b);
      transition: transform 0.5s ease, opacity 0.5s ease;
      z-index: 4;
    }

    .lid.open {
      transform: translate(-50%, -60px) rotate(-20deg);
      opacity: 0;
    }

    .star {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: twinkle 2.5s infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.4; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.3); }
    }

    .shake { animation: shake 1.2s ease; }

    @keyframes shake {
      0%, 100% { transform: rotate(0deg); }
      20%, 60% { transform: rotate(-8deg); }
      40%, 80% { transform: rotate(8deg); }
    }

    .paper {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, 0); 
        background: white;
        color: #1e293b;
        border-radius: 14px;
        border: 2px solid #cbd5f5;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        font-weight: bold;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        pointer-events: none;
        z-index: 5;
        padding: 15px;
        text-align: center;
        box-sizing: border-box;
    }

    .paper.fly {
        opacity: 1 !important;
        animation: flyOut 1.3s ease-out forwards;
    }

    @keyframes flyOut {
        0% { transform: translate(-50%, 0) scale(0.4) rotate(-20deg); }
        70% { transform: translate(-50%, -260px) scale(0.4) rotate(0deg); }
        100% {
            transform: translate(-50%, -280px) scale(1);
            width: 240px;
            height: 110px;
        }
    }

    .paper span {
      opacity: 0;
      animation: revealText 0.6s ease forwards;
      animation-delay: 1s;
      display: block;
      width: 100%;
    }

    @keyframes revealText { to { opacity: 1; } }

    button {
      padding: 12px 28px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(to right, #ec4899, #6366f1);
      color: white;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      transition: all 0.2s;
    }

    button:disabled { opacity: 0.6; cursor: wait; }
    button:active { transform: scale(0.95); }

    .excuse-btn {
      margin-top: 10px;
      padding: 4px 12px;
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #64748b;
      font-size: 11px;
      cursor: pointer;
      pointer-events: auto;
      transition: all 0.2s;
    }
    .excuse-btn:hover { background: #e2e8f0; color: #0f172a; }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>

  <div class="scene">
    <div class="jar-wrapper" id="jarWrapper">
      <div class="lid" id="lid"></div>
      <div class="neck"></div>
      <div class="jar" id="jarBody"></div>
      <div class="paper" id="paper"><span></span></div>
    </div>
    <button id="actionBtn" onclick="handleAction()">Goodbye boredom</button>
  </div>

  <div id="excuseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(37, 15, 58, 0.8); z-index: 100; align-items: center; justify-content: center;">
    <div style="background: white; padding: 25px; border-radius: 20px; max-width: 350px; width: 90%; text-align: center; color: #1e293b; box-shadow: 0 0 30px rgba(0,0,0,0.5);">
      <h3 id="modalTitle" style="margin-top: 0; color: #6366f1;">Here, use this excuse:</h3>
      <p id="modalExcuseText" style="font-style: italic; line-height: 1.4; min-height: 60px; display: flex; align-items: center; justify-content: center;"></p>
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
          <button id="factBtn" onclick="getRandomFact()" style="background: #ec4899; padding: 8px 12px; font-size: 12px;">Get a random fact instead</button>
          <button onclick="closeModal()" style="background: #94a3b8; padding: 8px 12px; font-size: 12px;">Close</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- BACKGROUND ANIMATION CODE ---------- */
    const canvas = document.getElementById("bgCanvas");
    const ctx = canvas.getContext("2d");

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    const bgStars = Array.from({ length: 200 }, () => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      r: Math.random() * 1.2 + 0.3,
      alpha: Math.random(),
      twinkle: Math.random() * 0.02 + 0.005
    }));

    const fireflies = Array.from({ length: 25 }, () => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 0.4,
      vy: (Math.random() - 0.5) * 0.4,
      glow: Math.random() * Math.PI * 2
    }));

    function drawBgStars() {
      for (const s of bgStars) {
        s.alpha += s.twinkle * (Math.random() > 0.5 ? 1 : -1);
        s.alpha = Math.max(0.2, Math.min(1, s.alpha));
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function drawFireflies() {
      for (const f of fireflies) {
        f.x += f.vx;
        f.y += f.vy;
        f.glow += 0.05;
        if (f.x < 0 || f.x > canvas.width) f.vx *= -1;
        if (f.y < 0 || f.y > canvas.height) f.vy *= -1;
        const pulse = (Math.sin(f.glow) + 1) / 2;
        ctx.beginPath();
        ctx.fillStyle = `rgba(180,255,120,${0.3 + pulse * 0.7})`;
        ctx.shadowColor = "rgba(180,255,120,0.8)";
        ctx.shadowBlur = 12;
        ctx.arc(f.x, f.y, 2 + pulse * 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
      }
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBgStars();
      drawFireflies();
      requestAnimationFrame(animate);
    }
    animate();

    /* ---------- MAGIC JAR LOGIC ---------- */
    const jar = document.getElementById("jarWrapper");
    const lid = document.getElementById("lid");
    const paper = document.getElementById("paper");
    const button = document.getElementById("actionBtn");
    const content = paper.querySelector('span');
    const jarBody = document.getElementById("jarBody");

    let state = "idle";

    // Create mini-stars inside the jar
    for (let i = 0; i < 24; i++) {
      const star = document.createElement("div");
      star.className = "star";
      star.style.left = Math.random() * 90 + "%";
      star.style.top = Math.random() * 90 + "%";
      star.style.background = `hsl(${Math.random() * 360}, 100%, 75%)`;
      star.style.animationDelay = Math.random() * 2 + "s";
      jarBody.appendChild(star);
    }

    async function handleAction() {
      if (state === "idle") {
        state = "animating";
        button.disabled = true;
        button.textContent = "Summoning activity...";

        try {
          const response = await fetch('http://127.0.0.1:5000/get-magic');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();

          content.innerHTML = `
            <div style="font-size: 40px; margin-bottom: 8px;">${data.emoji}</div>
            <div style="font-size: 15px; color: #334155; line-height: 1.2; font-weight: 600;">
              ${data.text}
            </div>
            <button class="excuse-btn" onclick="giveExcuse(event)">I don't want to do that...</button>
          `;
          runAnimations();
        } catch (error) {
          console.error("FETCH ERROR:", error);
          button.disabled = false;
          state = "idle";
          button.textContent = "Goodbye boredom";
        }
      } else if (state === "revealed") {
        resetJar();
      }
    }

    function runAnimations() {
      jar.classList.add("shake");
      setTimeout(() => lid.classList.add("open"), 800);
      setTimeout(() => paper.classList.add("fly"), 1200);
      setTimeout(() => {
        jar.classList.remove("shake");
        button.textContent = "Reset jar";
        button.disabled = false;
        state = "revealed";
      }, 1600);
    }

    function resetJar() {
      lid.classList.remove("open");
      paper.classList.remove("fly");
      button.textContent = "Goodbye boredom";
      state = "idle";
    }

    async function giveExcuse(event) {
      event.stopPropagation();
      const btn = event.target;
      const modal = document.getElementById('excuseModal');
      const modalText = document.getElementById('modalExcuseText');
      btn.textContent = "Thinking...";
      btn.disabled = true;

      try {
        const response = await fetch('http://127.0.0.1:5000/get-excuse');
        const data = await response.json();
        modalText.textContent = data.excuse;
        modal.style.display = 'flex';
        btn.textContent = "I don't want to do that...";
        btn.disabled = false;
      } catch (error) {
        modalText.textContent = "My pet dragon ate my internet connection.";
        modal.style.display = 'flex';
        btn.disabled = false;
      }
    }

    async function getRandomFact() {
      const modalText = document.getElementById('modalExcuseText');
      const modalTitle = document.getElementById('modalTitle');
      const factBtn = document.getElementById('factBtn');
      factBtn.textContent = "Loading...";
      factBtn.disabled = true;

      try {
        const response = await fetch('https://uselessfacts.jsph.pl/api/v2/facts/random');
        const data = await response.json();
        modalTitle.textContent = "Random Fact";
        modalTitle.style.color = "#ec4899";
        modalText.textContent = data.text;
        factBtn.textContent = "Get another fact";
        factBtn.disabled = false;
      } catch (error) {
        modalText.textContent = "Fun fact: My fact-checker is on strike.";
        factBtn.disabled = false;
      }
    }

    function closeModal() {
      document.getElementById('excuseModal').style.display = 'none';
      document.getElementById('modalTitle').textContent = "Here, use this excuse:";
      document.getElementById('modalTitle').style.color = "#6366f1";
    }
  </script>
</body>
</html>