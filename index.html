<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magic Jar</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: radial-gradient(circle at top, #1e1b4b, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, sans-serif;
      color: white;
      overflow: hidden;
    }

    .scene { text-align: center; }

    .jar-wrapper {
      position: relative;
      width: 220px;
      height: 340px;
      margin-bottom: 24px;
    }

    .jar {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 280px;
      border-radius: 60px;
      background: linear-gradient(to bottom, rgba(165,243,252,0.35), rgba(99,102,241,0.3), rgba(236,72,153,0.35));
      border: 4px solid #bae6fd;
      backdrop-filter: blur(6px);
      box-shadow: 0 0 40px rgba(120,200,255,0.6);
      overflow: hidden;
      z-index: 1;
    }

    .neck {
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      width: 110px;
      height: 36px;
      border-radius: 20px;
      border: 4px solid #bae6fd;
      background: rgba(165,243,252,0.4);
      z-index: 3;
    }

    .lid {
      position: absolute;
      top: -46px;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(to right, #fde68a, #f59e0b);
      transition: transform 0.5s ease, opacity 0.5s ease;
      z-index: 4;
    }

    .lid.open {
      transform: translate(-50%, -60px) rotate(-20deg);
      opacity: 0;
    }

    .star {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: twinkle 2.5s infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.4; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.3); }
    }

    .shake { animation: shake 1.2s ease; }

    @keyframes shake {
      0%, 100% { transform: rotate(0deg); }
      20%, 60% { transform: rotate(-8deg); }
      40%, 80% { transform: rotate(8deg); }
    }

    .paper {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, 0); 
        background: white;
        color: #1e293b;
        border-radius: 14px;
        border: 2px solid #cbd5f5;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        font-weight: bold;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        pointer-events: none;
        z-index: 5;
        padding: 15px;
        text-align: center;
        box-sizing: border-box;
    }

    .paper.fly {
        opacity: 1 !important;
        animation: flyOut 1.3s ease-out forwards;
    }

    @keyframes flyOut {
        0% { transform: translate(-50%, 0) scale(0.4) rotate(-20deg); }
        70% { transform: translate(-50%, -260px) scale(0.4) rotate(0deg); }
        100% {
            transform: translate(-50%, -280px) scale(1);
            width: 240px;
            height: 110px;
        }
    }

    .paper span {
      opacity: 0;
      animation: revealText 0.6s ease forwards;
      animation-delay: 1s;
      display: block;
      width: 100%;
    }

    @keyframes revealText { to { opacity: 1; } }

    button {
      padding: 12px 28px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(to right, #ec4899, #6366f1);
      color: white;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      transition: all 0.2s;
    }

    button:disabled { opacity: 0.6; cursor: wait; }
    button:active { transform: scale(0.95); }

    .excuse-btn {
      margin-top: 10px;
      padding: 4px 12px;
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      color: #64748b;
      font-size: 11px;
      cursor: pointer;
      pointer-events: auto; /* Important: Paper has pointer-events: none */
      transition: all 0.2s;
    }
    .excuse-btn:hover {
      background: #e2e8f0;
      color: #0f172a;
    }
    .excuse-text {
      font-style: italic;
      font-size: 13px;
      color: #6366f1;
      margin-top: 8px;
      display: block;
    }
  </style>
</head>
<body>
  <div class="scene">
    <div class="jar-wrapper" id="jarWrapper">
      <div class="lid" id="lid"></div>
      <div class="neck"></div>
      <div class="jar" id="jarBody"></div>
      <div class="paper" id="paper"><span></span></div>
    </div>

    <button id="actionBtn" onclick="handleAction()">Shake the magic jar</button>
  </div>

  <script>
    const jar = document.getElementById("jarWrapper");
    const lid = document.getElementById("lid");
    const paper = document.getElementById("paper");
    const button = document.getElementById("actionBtn");
    const content = paper.querySelector('span');

    let state = "idle";

    // Create stars inside the jar
    const jarBody = document.getElementById("jarBody");
    for (let i = 0; i < 24; i++) {
      const star = document.createElement("div");
      star.className = "star";
      star.style.left = Math.random() * 90 + "%";
      star.style.top = Math.random() * 90 + "%";
      star.style.background = `hsl(${Math.random() * 360}, 100%, 75%)`;
      star.style.animationDelay = Math.random() * 2 + "s";
      jarBody.appendChild(star);
    }

    async function handleAction() {
      if (state === "idle") {
        state = "animating";
        button.disabled = true;
        button.textContent = "Summoning...";

        try {
          // Use the exact URL that worked in your browser bar
          const response = await fetch('http://127.0.0.1:5000/get-magic');
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();

          // Fill the paper with the Python data
          content.innerHTML = `
            <div style="font-size: 40px; margin-bottom: 8px;">${data.emoji}</div>
            <div style="font-size: 15px; color: #334155; line-height: 1.2; font-weight: 600;">
              ${data.text}
            </div>
            <button class="excuse-btn" id="excuseBtn" onclick="giveExcuse(event)">I can't do that...</button>
          `;

          runAnimations();

        } catch (error) {
          console.error("FETCH ERROR:", error);
          // button.textContent = "Check Console (F12)";
          button.disabled = false;
          state = "idle";
        }
      } else if (state === "revealed") {
        resetJar();
      }
    }

    async function giveExcuse(event) {
      event.stopPropagation();
      
      const btn = event.target;
      const modal = document.getElementById('excuseModal');
      const modalText = document.getElementById('modalExcuseText');
      
      btn.textContent = "Thinking...";
      btn.disabled = true;

      try {
        const response = await fetch('http://127.0.0.1:5000/get-excuse');
        const data = await response.json();
        
        // Fill and show the modal
        modalText.textContent = data.excuse;
        modal.style.display = 'flex';
        
        // Reset button for next time
        btn.textContent = "I can't do that...";
        btn.disabled = false;
      } catch (error) {
        modalText.textContent = "My pet dragon ate my internet connection.";
        modal.style.display = 'flex';
        btn.disabled = false;
      }
      // Add these two lines inside your existing giveExcuse function
      document.getElementById('modalTitle').textContent = "The Excuse";
      document.getElementById('modalTitle').style.color = "#6366f1";
      document.getElementById('factBtn').textContent = "Get a random fact instead";
    }

    function closeModal() {
      document.getElementById('excuseModal').style.display = 'none';
    }
   
    async function getRandomFact() {
      const modalText = document.getElementById('modalExcuseText');
      const modalTitle = document.getElementById('modalTitle');
      const factBtn = document.getElementById('factBtn');

      factBtn.textContent = "Loading...";
      factBtn.disabled = true;

      try {
        const response = await fetch('https://uselessfacts.jsph.pl/api/v2/facts/random');
        const data = await response.json();
        
        // Update the modal content
        modalTitle.textContent = "Random Fact";
        modalTitle.style.color = "#ec4899"; // Change color to match the pink button
        modalText.textContent = data.text;
        
        factBtn.textContent = "Get another fact";
        factBtn.disabled = false;
      } catch (error) {
        modalText.textContent = "Fun fact: My fact-checker is on strike.";
        factBtn.disabled = false;
      }
    }

    // Update your existing closeModal to reset the title
    function closeModal() {
      document.getElementById('excuseModal').style.display = 'none';
      // Reset title for the next time an excuse is generated
      document.getElementById('modalTitle').textContent = "The Excuse";
      document.getElementById('modalTitle').style.color = "#6366f1";
    }

    function runAnimations() {
      jar.classList.add("shake");
      
      setTimeout(() => lid.classList.add("open"), 800);
      setTimeout(() => paper.classList.add("fly"), 1200);

      setTimeout(() => {
        jar.classList.remove("shake");
        button.textContent = "Reset jar";
        button.disabled = false;
        state = "revealed";
      }, 1600);
    }

    function resetJar() {
      lid.classList.remove("open");
      paper.classList.remove("fly");
      button.textContent = "Shake the magic jar";
      state = "idle";
    }
  </script>
  <div id="excuseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center;">
    <div style="background: white; padding: 25px; border-radius: 20px; max-width: 350px; width: 90%; text-align: center; color: #1e293b; box-shadow: 0 0 30px rgba(0,0,0,0.5);">
      <h3 id="modalTitle" style="margin-top: 0; color: #6366f1;">The Excuse</h3>
      <p id="modalExcuseText" style="font-style: italic; line-height: 1.4; min-height: 60px; display: flex; align-items: center; justify-content: center;"></p>
      
      <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
          <button id="factBtn" onclick="getRandomFact()" style="background: #ec4899; padding: 8px 12px; font-size: 12px;">Get a random fact instead</button>
          <button onclick="closeModal()" style="background: #94a3b8; padding: 8px 12px; font-size: 12px;">Close</button>
      </div>
    </div>
  </div>
</body>
</html>